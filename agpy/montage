#!/bin/bash

# Wrapper to mosaic a *subset* of images in the current directory
#
# Usage:
# mGetHdr template_fitsfile.fit mosaic.hdr
# montage outfile=l089_reference_montage.fits 0*_indiv13pca*_map01.fits combine=median &
#
# Keyword parameters:
#   combine - 'median', 'average', or 'sum'
#   header  - Filename of fits file from which to create mosaic.hdr
#   outfile - Output fits filename
#

#export PATH=$PATH:/usr/local/bin/montage

origdir=`pwd`

if [ $# -gt 0 ]
then
    for ii in $*
    do
        if [ ${ii%=*} == 'header' ]
        then
            hdrfile=${ii#*=}
            if [ ${hdrfile#*.} == 'hdr' ]
            then
              headerfile=$hdrfile
            elif [ ${hdrfile#*.} == 'fits' ]
            then
              /usr/local/bin/montage/mGetHdr $hdrfile mosaic.hdr
              headerfile=mosaic.hdr
            else
              echo "ERROR: $ii is not a valid header setting"
              headerfile="does_not_exist_I_hope.noooo"
            fi
        elif [ ${ii%=*} == 'outfile' ]
        then
            outfile=${ii#*=}
        elif [ `echo $ii | grep =` ] 
        then
            params="$params,${ii%=*}='${ii#*=}'"
        # note that you can say "header=blah.fits" because it is checked for earlier
        elif [ `echo $ii | grep ".fits"` ] 
        then
            files=( ${files[@]} $ii )
        fi
    done
fi
echo ${files[@]} ${#files} 
if [ ${#files} -gt 0 ] 
then
    mkdir tmp
    cp ${files[@]} tmp/
    cp $headerfile tmp/
    cd tmp/
fi

if [ -f $headerfile ] 
then 
    echo "$headerfile exists, continuing"

    dir=`pwd`
    echo python -c "import montage; montage.wrappers.mosaic('$dir','$dir/mosaic',header='$dir/$headerfile'$params)"
    python -c "import montage; montage.wrappers.mosaic('$dir','$dir/mosaic',header='$dir/$headerfile'$params)"
    if [ $? != 0 ]
    then
      echo "There was a python error!"
    fi

    cd $origdir
    if [ -d tmp ]
    then
        if [ $outfile ]
        then
            mv tmp/mosaic/mosaic.fits $outfile
        else
            mv tmp/mosaic mosaic
        fi
        rm -r tmp
    fi

else
    echo "$headerfile does not exist.  Quitting."
    cd $origdir
fi

#for ii in $*
#do
#    var="from agpy import pyflagger; f=pyflagger.Flagger('"$ii"'); f.plotscan(0)"
#    echo ipython -i -c \"$var\"
#    ipython -i -c "from pylab import *; from agpy import pyflagger; f=pyflagger.Flagger('"$ii"'); f.plotscan(0);"
#done
